# Промпт за Бутон Управление на LED Ленти

## Описание на функционалността

Система за управление на множество LED ленти чрез един бутон с различни режими на работа в зависимост от начина на натискане.

## Основни режими

### 1. Нормален режим (извън режим на управление)

**Единично натискане (click):**

- Ако има дори една светеща лента → изгаси всички ленти с ефект събиране към центъра за 1 секунда
- Ако всички ленти са изключени → включи всички ленти в бяло на 50% яркост с ефект от центъра към краищата за 1 секунда

**Кратко натискане (< 200ms):**

- Превключва между лентите (включително изключените)
- Използва се само в режим на управление

### 2. Режим на управление (след задържане 1 секунда)

**Активация:**

- При задържане на бутона за 1 секунда, системата минава в режим на управление
- Маркира се първата светеща лента (или произволна ако нито една не свети)
- Ако нито една лента не свети, произволна лента светва на 50% бяло и се маркира
- Визуален индикатор започва веднага след задържане 1 секунда

**Визуален индикатор на маркираната лента:**

- Всеки 10-ти диод сменя цветовете RGB (червено → зелено → син → червено...)
- Смяна на всяка 0.5 секунди
- Спира докато бутонът е натиснат (при димиране/увеличаване)
- Започва отново при отпускане на бутона

**В режим на управление:**

**Кратко натискане (< 200ms):**

- Превключва към друга лента (включително изключените)
- Изключените ленти светват на 50% бяло и започват визуален индикатор
- Предишната маркирана лента спира визуалния индикатор
- Новата лента започва визуален индикатор веднага

**Натискане и задържане:**

- Ако лентата не е димвана/увеличена → започва димиране надолу до минимум
- Визуалният индикатор спира докато бутонът е натиснат
- При отпускане → визуалният индикатор започва отново
- Ако лентата вече е димвана → започва увеличаване до максимум
- Скорост: от минимум до максимум за 5 секунди (плавно)
- При достигане на мин/макс → спира там дори и бутонът да е натиснат

**Излизане от режим:**

- При 3 секунди без натискане на бутона
- Визуалният индикатор спира
- Няма маркирана лента
- Лентата остава с настроената яркост
- Системата се връща към нормален режим

## Поведение на лентите

- **При включване:** Всички ленти светват в бяло на 50% яркост (128/255)
- **Маркираната лента:** Показва визуален индикатор (всеки 10-ти диод RGB), може да се димира/увеличава
- **Немаркираните ленти:** Не се променят, запазват текущото си състояние
- **Изключени ленти при превключване:** Светват на 50% бяло и започват визуален индикатор

## Параметри

| Параметър                   | Стойност | Описание                                               |
| --------------------------- | -------- | ------------------------------------------------------ |
| `BUTTON_DEBOUNCE_TIME`      | 50ms     | Време за debounce на бутона                            |
| `BUTTON_SHORT_PRESS_MAX`    | 200ms    | Максимално време за кратко натискане (превключване)    |
| `BUTTON_LONG_PRESS_TIME`    | 1000ms   | Време за "дълго" натискане (активиране на режим)       |
| `BUTTON_IDLE_TIMEOUT`       | 3000ms   | Време без натискане за излизане от режим               |
| `VISUAL_INDICATOR_INTERVAL` | 500ms    | Интервал за смяна на цветовете на визуалния индикатор  |
| `VISUAL_INDICATOR_STEP`     | 10       | Всеки N-ти диод показва визуален индикатор             |
| `DIMMING_TIME`              | 5000ms   | Време за димиране/увеличаване от мин до макс           |
| `DIMMING_UPDATE_INTERVAL`   | 20ms     | Интервал за обновяване на яркостта при димиране        |
| `MIN_BRIGHTNESS`            | 10       | Минимална яркост (0-255)                               |
| `MAX_BRIGHTNESS`            | 255      | Максимална яркост (0-255)                              |
| `DEFAULT_BRIGHTNESS`        | 150      | Първоначална яркост (0-255)                            |
| `INACTIVE_STRIP_BRIGHTNESS` | 128      | Яркост за изключени ленти при превключване (50% = 128) |
| `WIPE_EFFECT_TIME`          | 1000ms   | Време за ефект от центъра към краищата                 |
| `WIPE_HOLD_TIME`            | 2000ms   | Време за задържане на ефекта преди изгасване           |

## Състояния на системата

### State Machine

```
NORMAL_MODE
├─ Click → Toggle all strips
└─ Hold 1s → CONTROL_MODE

CONTROL_MODE
├─ Short press → Switch marked strip
├─ Hold → Dim/Increase marked strip
└─ 3s idle → NORMAL_MODE
```

## Гранични случаи

1. **Всички ленти изключени + задържане 1s:**

   - Произволна лента светва на 50% бяло
   - Започва визуален индикатор
   - Влиза в режим на управление

2. **Достигане на мин/макс при димиране:**

   - Спира димиране/увеличаване
   - Остава на мин/макс дори и бутонът да е натиснат
   - При отпускане → визуален индикатор започва отново

3. **Превключване към изключена лента:**

   - Лентата светва на 50% бяло
   - Започва визуален индикатор веднага
   - Предишната лента спира визуалния индикатор

4. **Две ленти светят + задържане 1s:**

   - Първата светеща лента се маркира
   - Започва визуален индикатор
   - Другата лента не се променя

5. **Димиране/увеличаване при достигнат минимум/максимум:**
   - Спира автоматично
   - Не продължава да димира/увеличава

## Технически детайли

- **Debounce:** Всички натискания трябва да имат debounce
- **Плавност:** Димирането/увеличаването трябва да е плавно (линейна интерполация)
- **Цветове на лентите:** При включване лентите светят в бяло на 50% яркост (128/255)
- **Визуален индикатор:** RGB цветовете се сменят последователно (червено → зелено → син → червено...)
- **Цветовете:** R и G са разменени в хардуера (използва се `fixColor()` функция) - само за визуалния индикатор
- **Паралелна работа:** Всички ленти работят независимо, но се управляват от един бутон

## Примерен flow

1. Всички ленти изключени
2. Единично натискане → Всички ленти светват в бяло на 50% с ефект от центъра (1 сек)
3. Единично натискане → Всички ленти се изгасят с ефект събиране към центъра (1 сек)
4. Единично натискане → Всички ленти светват в бяло на 50% с ефект от центъра (1 сек)
5. Задържане 1 секунда → Лента 1 се маркира, започва визуален индикатор
6. Кратко натискане → Превключва към лента 2, лента 2 започва визуален индикатор
7. Натискане и задържане → Лента 2 димира до минимум (5 сек), визуалният индикатор спира
8. Отпускане → Визуалният индикатор започва отново
9. Пак натискане и задържане → Лента 2 увеличава до максимум (5 сек)
10. 3 секунди без натискане → Излизане от режим, визуалният индикатор спира, лента 2 остава на максимум
