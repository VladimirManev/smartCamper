# Модул 1 - ESP32 Сензорен Модул

## Преглед

Модул 1 е ESP32-базиран сензорен модул, проектиран за системата SmartCamper. Предоставя мониторинг на температура и влажност чрез DHT22/AM2301 сензор, мониторинг на нивото на сивата вода чрез електроди базирани на проводимост, и мониторинг на температурата на сивата вода чрез DS18B20 сензор, с разширяема архитектура, която позволява добавяне на допълнителни сензори.

## Архитектура

### Основни Компоненти

1. **ModuleManager** - Обща инфраструктура (Мрежа, MQTT, Heartbeat, Команди)
   - Управлява WiFi свързаност
   - Управлява MQTT комуникация
   - Изпраща heartbeat съобщения
   - Обработва команди от backend

2. **SensorManager** - Координатор на сензорите
   - Координира всички сензорни класове
   - Обработва заявки за принудително обновяване
   - Управлява жизнения цикъл на сензорите

3. **TemperatureHumiditySensor** - DHT22 сензорна имплементация
   - Чете температура и влажност
   - Открива промени и публикува данни
   - Обработва специфичната за сензора логика

4. **WaterLevelSensor** - Сензор за ниво на сива вода
   - Чете нивото на водата чрез електроди базирани на проводимост
   - Използва последователно измерване (един пин наведнъж) за предотвратяване на електрически смущения
   - Изчислява mode (най-често срещаната стойност) от 5 измерения за стабилност
   - Открива промени и публикува данни (≥1% праг, без heartbeat)
   - Обработва специфичната за сензора логика

5. **WaterTemperatureSensor** - DS18B20 сензор за температура на сива вода
   - Чете температурата на водата чрез DS18B20 (OneWire протокол)
   - Измерва на всяка 1 секунда и буферира показанията
   - Изчислява средна стойност от 5 измерения на всеки 5 секунди
   - Открива промени и публикува данни (≥0.1°C праг, без heartbeat)
   - Обработва специфичната за сензора логика

### Принципи на Дизайна

- **Разделение на Отговорностите**: Инфраструктурата (ModuleManager) е отделена от логиката на сензорите
- **Разширяемост**: Лесно добавяне на нови сензори без промяна на съществуващия код
- **Преизползваемост**: ModuleManager може да се копира в други модули както е
- **Поддръжка**: Ясна структура и отговорности

## Хардуерна Конфигурация

### DHT22/AM2301 Сензор
- **Pin**: GPIO 25 (конфигурируемо в `Config.h`)
- **Тип**: DHT22 (конфигурируемо в `Config.h`)
- **Захранване**: 3.3V
- **Данни**: Цифров pin 25

### Сензор за Ниво на Сива Вода
- **Тип**: Откриване на ниво чрез проводимост с неръждаеми болтове
- **Електроди**: 8 неръждаеми болта (1 GND + 7 за откриване на ниво)
- **Level Pins**: GPIO 4, 5, 18, 19, 21, 22, 23 (конфигурируеми в `Config.h`)
- **Нива**: 15%, 30%, 45%, 60%, 75%, 90%, 100%
- **Метод на Измерване**: Последователно четене на пинове (един пин наведнъж с PULLUP)
  - Измерва от горе надолу (Pin 7 → Pin 1)
  - Само един пин е PULLUP в даден момент, за да се предотврати водата да стане по-положителна
  - LOW = покрит от вода (свързан към GND), HIGH = не покрит

### DS18B20 Сензор за Температура на Сива Вода
- **Pin**: GPIO 26 (конфигурируемо в `Config.h`)
- **Тип**: DS18B20 (OneWire протокол)
- **Захранване**: 3.3V (от ESP32)
- **Данни**: Цифров pin 26 с 4.7kΩ-5.1kΩ pull-up резистор към 3.3V
- **Резолюция**: 12-bit (0.0625°C точност, закръглено до 0.1°C)
- **Връзка**:
  - DS18B20 Pin 1 (GND) → ESP32 GND
  - DS18B20 Pin 2 (Data) → ESP32 GPIO 26 → 4.7kΩ-5.1kΩ резистор → ESP32 3.3V
  - DS18B20 Pin 3 (VDD) → ESP32 3.3V

## Софтуерна Конфигурация

### Идентификация на Модула
- **Module ID**: `module-1` (дефинирано в `Config.h`)

### MQTT Topics

**Heartbeat:**
```
smartcamper/heartbeat/module-1
```

**Данни от Сензори:**
```
smartcamper/sensors/temperature
smartcamper/sensors/humidity
smartcamper/sensors/gray-water/level
smartcamper/sensors/gray-water-temperature
```

**Команди:**
```
smartcamper/commands/module-1/force_update
```

### Конфигурация на Тайминга

- **Интервал за Четене на Сензор**: 1 секунда
- **Интервал на Heartbeat**: 10 секунди
- **Праг на Температура**: 0.1°C (откриване на промяна)
- **Праг на Влажност**: 1% (откриване на промяна)
- **Интервал за Четене на Ниво на Вода**: 1 секунда
- **Интервал за Усредняване на Ниво на Вода**: 5 секунди (изчислява mode от последните 5 измерения)
- **Праг на Ниво на Вода**: 1% (откриване на промяна, без heartbeat)
- **Обработка на Данни за Ниво**: Mode (най-често срещаната стойност) от последните 5 измерения
- **Интервал за Четене на Температура на Вода**: 1 секунда
- **Интервал за Усредняване на Температура на Вода**: 5 секунди (изчислява средна стойност от последните 5 измерения)
- **Праг на Температура на Вода**: 0.1°C (откриване на промяна, без heartbeat)
- **Обработка на Данни за Температура на Вода**: Средна стойност от последните 5 измерения
- **Интервал за Четене на Температура (DHT22)**: 1 секунда
- **Интервал за Усредняване на Температура (DHT22)**: 5 секунди (изчислява средна стойност от последните 5 измерения)

## Добавяне на Нови Сензори

За да добавите нов сензор (например, ниво на вода):

1. Създайте нов сензорен клас:
```cpp
// include/WaterLevelSensor.h
class WaterLevelSensor {
  // Специфична за сензора логика
};
```

2. Добавете в SensorManager:
```cpp
// include/SensorManager.h
class SensorManager {
  TemperatureHumiditySensor temperatureHumiditySensor;
  WaterLevelSensor waterLevelSensor;  // Нов сензор
};
```

3. Инициализирайте и обновявайте в SensorManager:
```cpp
void SensorManager::loop() {
  temperatureHumiditySensor.loop();
  waterLevelSensor.loop();  // Нов сензор
}
```

## Компилиране и Качване

```bash
# Компилиране на проекта
pio run

# Качване на ESP32
pio run -t upload

# Мониториране на сериен изход
pio device monitor
```

## Зависимости

- `knolleary/PubSubClient@^2.8` - MQTT клиент
- `adafruit/DHT sensor library@^1.4.4` - Библиотека за DHT сензор
- `adafruit/Adafruit Unified Sensor@^1.1.14` - Унифицирана сензорна библиотека
- `bblanchon/ArduinoJson@^6.21.3` - JSON парсиране
- `paulstoffregen/OneWire@^2.3.7` - Библиотека за OneWire протокол
- `milesburton/DallasTemperature` - Библиотека за Dallas Temperature (поддръжка на DS18B20)

## Структура на Файловете

```
module-1/
├── include/
│   ├── CommandHandler.h          # Обработка на команди
│   ├── HeartbeatManager.h        # Heartbeat функционалност
│   ├── ModuleManager.h           # Мениджър на инфраструктурата
│   ├── SensorManager.h           # Координатор на сензорите
│   ├── TemperatureHumiditySensor.h # DHT сензорна логика
│   ├── WaterLevelSensor.h        # Логика за сензор на ниво на вода
│   └── WaterTemperatureSensor.h  # Логика за DS18B20 сензор за температура на вода
├── src/
│   ├── CommandHandler.cpp
│   ├── Config.h                  # Конфигурационни константи
│   ├── HeartbeatManager.cpp
│   ├── main.cpp                  # Точка на влизане
│   ├── ModuleManager.cpp
│   ├── MQTTManager.cpp/h         # MQTT комуникация
│   ├── NetworkManager.cpp/h       # WiFi управление
│   ├── SensorManager.cpp
│   ├── TemperatureHumiditySensor.cpp
│   ├── WaterLevelSensor.cpp
│   └── WaterTemperatureSensor.cpp
├── platformio.ini                # PlatformIO конфигурация
├── README.md                     # Този файл (на английски)
├── README_BG.md                  # Този файл (на български)
└── HEARTBEAT_DOCUMENTATION.md    # Документация за heartbeat системата
```

## Бележки

- Module ID се дефинира в `Config.h` като `MODULE_ID`
- DHT сензорният pin и тип са конфигурируеми в `Config.h`
- Pins и прагове на сензора за ниво на вода са конфигурируеми в `Config.h`
- Всички специфични за сензора прагове са в `Config.h`
- ModuleManager е преизползваем във всички модули
- Сензорните класове са независими и могат лесно да се добавят/премахнат
- Сензорът за ниво на вода използва изчисляване на mode (най-често срещаната стойност от 5 измерения) за намаляване на шума
- Сензорът за ниво на вода измерва един пин наведнъж (последователно измерване) за предотвратяване на електрически смущения
- Сензорът за ниво на вода публикува само при промяна (≥1% праг), без heartbeat
- Сензорът за температура на вода използва усредняване (средна стойност от 5 измерения) за стабилност
- Сензорът за температура на вода публикува само при промяна (≥0.1°C праг), без heartbeat
- Сензорът за температура (DHT22) използва усредняване (средна стойност от 5 измерения) за стабилност

## Подобрения и Безопасност

Модулът включва следните подобрения за production-ready код:

- **Null Pointer Validation**: Проверка за nullptr във всички критични места
- **Input Validation**: Валидация на входни параметри и стойности от сензорите
- **Error Handling**: Подобрена обработка на грешки с ясни съобщения
- **Initialization Checks**: Проверка на състоянието на инициализация
- **Const Correctness**: Използване на const методи където е подходящо
- **Bounds Checking**: Валидация на стойности от сензорите (температура: -40 до 80°C, влажност: 0-100%)

