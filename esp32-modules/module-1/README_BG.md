# Module-1: Сензори за околна среда

ESP32 модул за мониторинг на вътрешна температура, вътрешна влажност, външна температура, ниво на вода и температура на водата.

## Хардуерна конфигурация

### Таблица с пинове

| Компонент | Пин | Тип | Описание |
|-----------|-----|-----|----------|
| **DHT22/AM2301** | 25 | Вход | Сензор за вътрешна температура и влажност |
| **DS18B20 (Вода)** | 26 | Вход | Сензор за температура на сива вода (OneWire) |
| **DS18B20 (Външен)** | 27 | Вход | Сензор за външна температура (OneWire) |
| **Ниво вода 1** | 4 | Вход | Откриване на 15% ниво |
| **Ниво вода 2** | 5 | Вход | Откриване на 30% ниво |
| **Ниво вода 3** | 18 | Вход | Откриване на 45% ниво |
| **Ниво вода 4** | 19 | Вход | Откриване на 60% ниво |
| **Ниво вода 5** | 21 | Вход | Откриване на 75% ниво |
| **Ниво вода 6** | 22 | Вход | Откриване на 90% ниво |
| **Ниво вода 7** | 23 | Вход | Откриване на 100% ниво |

### Спецификации на сензорите

**DHT22/AM2301 (Вътрешен):**
- Диапазон температура: -40°C до 80°C
- Диапазон влажност: 0-100% RH
- Точност: ±0.5°C, ±1% RH
- Интервал на обновяване: 1 секунда

**DS18B20 (Сива вода):**
- Диапазон температура: -55°C до 125°C
- Точност: ±0.5°C
- Интервал на обновяване: 1 секунда (средна стойност за 5 сек)

**DS18B20 (Външен):**
- Диапазон температура: -55°C до 125°C
- Точност: ±0.5°C
- Интервал на обновяване: 1 секунда (средна стойност за 5 сек)

**Сензор за ниво на вода:**
- 7-ниво откриване (15%, 30%, 45%, 60%, 75%, 90%, 100%)
- Цифрови пинове с pull-up резистори
- Интервал на обновяване: 1 секунда (средна стойност за 5 сек)

## Мрежова конфигурация

- **WiFi SSID**: `SmartCamper`
- **WiFi Парола**: `12344321`
- **MQTT Broker IP**: `192.168.4.1` (Raspberry Pi)
- **MQTT Broker Порт**: `1883`
- **ID на модула**: `module-1`

## MQTT Topics

### Публикувани (Данни от сензори)

| Topic | Формат на съобщението | Честота на обновяване |
|-------|----------------------|----------------------|
| `smartcamper/sensors/module-1/indoor-temperature` | `{"value": 22.5, "timestamp": 1234567890}` | При промяна (>0.1°C) |
| `smartcamper/sensors/module-1/indoor-humidity` | `{"value": 45.0, "timestamp": 1234567890}` | При промяна (>1%) |
| `smartcamper/sensors/module-1/outdoor-temperature` | `{"value": 18.5, "timestamp": 1234567890}` | При промяна (>0.1°C) |
| `smartcamper/sensors/module-1/gray-water/level` | `{"value": 75, "timestamp": 1234567890}` | При промяна (>1%) |
| `smartcamper/sensors/module-1/gray-water-temperature` | `{"value": 18.5, "timestamp": 1234567890}` | При промяна (>0.1°C) |
| `smartcamper/heartbeat/module-1` | `{"timestamp": 1234567890, "moduleId": "module-1", "uptime": 3600, "wifiRSSI": -65}` | На всеки 10 секунди |

### Абонирани (Команди)

| Topic | Payload | Действие |
|-------|---------|----------|
| `smartcamper/commands/module-1/force_update` | `{}` | Принудително публикуване на всички данни |

## Инсталация и настройка

1. **Качване на firmware:**
   ```bash
   cd esp32-modules/module-1
   pio run --target upload
   ```

2. **Мониторинг на serial изход:**
   ```bash
   pio device monitor
   ```
   - Проверка на WiFi връзка
   - Проверка на MQTT връзка
   - Мониторинг на показанията от сензорите

3. **Проверка на работата:**
   - Проверете dashboard-а за данни от сензорите
   - Проверете статус иконката за heartbeat (синьо = онлайн, червено = офлайн)

## Отстраняване на проблеми

### Няма WiFi връзка
- Проверете SSID и парола в `src/Config.h`
- Уверете се, че WiFi рутерът излъчва мрежата `SmartCamper`
- Проверете serial изхода за грешки при свързване

### Няма MQTT връзка
- Проверете IP адреса на MQTT broker в `src/Config.h` (по подразбиране: `192.168.4.1`)
- Проверете дали Raspberry Pi работи и MQTT broker е активен
- Проверете мрежовата свързаност (ping на MQTT broker IP)

### Няма показания от сензори
- **DHT22 (Вътрешен)**: Проверете свързването (VCC, GND, DATA пин 25)
- **DS18B20 (Вода)**: Проверете OneWire pull-up резистор (4.7kΩ) и свързването на пин 26
- **DS18B20 (Външен)**: Проверете OneWire pull-up резистор (4.7kΩ) и свързването на пин 27
- **Ниво на вода**: Проверете всички 7 пина (4, 5, 18, 19, 21, 22, 23) да са свързани
- Проверете serial изхода за грешки от сензорите

### Сензор показва грешни стойности
- **Вътрешна температура/Влажност**: DHT22 може да се нуждае от 2-3 секунди между четенията
- **Ниво на вода**: Проверете свързванията на сензора и контакта с водата
- **Температура на вода**: Уверете се, че DS18B20 (пин 26) е правилно запечатан и потопен
- **Външна температура**: Уверете се, че DS18B20 (пин 27) е правилно позициониран и свързан

## Офлайн работа

Модулът работи независимо:
- Сензорите продължават да четат дори без WiFi/MQTT
- Данните се буферират и публикуват при възстановяване на връзката
- Автоматично преподключване към WiFi и MQTT на всеки 2-3 секунди

## Архитектура

- **ModuleManager**: Управлява WiFi, MQTT, Heartbeat, Команди
- **SensorManager**: Координира всички сензори (DHT22, Ниво на вода, DS18B20 Вода, DS18B20 Външен)
- **NetworkManager**: WiFi връзка и преподключване
- **MQTTManager**: MQTT комуникация и автоматично преподключване
- **HeartbeatManager**: Изпраща статус на всеки 10 секунди

## Serial Debug Изход

Включване/изключване в `src/Config.h`:
- `DEBUG_SERIAL`: Serial конзолен изход
- `DEBUG_MQTT`: MQTT съобщения за публикуване/абониране
- `DEBUG_VERBOSE`: Подробни показания от сензорите

