# Module-3: Контролер за подово отопление

ESP32 модул за управление на система за подово отопление с автоматичен температурен контрол, бутони за ръчно управление и 4 независими отоплителни кръга.

## Хардуерна конфигурация

### Таблица с пинове

| Компонент                             | Пин | Тип            | Описание                              |
| ------------------------------------- | --- | -------------- | ------------------------------------- |
| **Кръг 0 Темп. Сензор** (Централен 1) | 25  | Вход           | DS18B20 температурен сензор (OneWire) |
| **Кръг 1 Темп. Сензор** (Централен 2) | 26  | Вход           | DS18B20 температурен сензор (OneWire) |
| **Кръг 2 Темп. Сензор** (Баня)        | 27  | Вход           | DS18B20 температурен сензор (OneWire) |
| **Кръг 3 Темп. Сензор** (Подиум)      | 33  | Вход           | DS18B20 температурен сензор (OneWire) |
| **Кръг 0 Реле** (Централен 1)         | 4   | Изход          | Контрол на реле за кръг 0             |
| **Кръг 1 Реле** (Централен 2)         | 5   | Изход          | Контрол на реле за кръг 1             |
| **Кръг 2 Реле** (Баня)                | 18  | Изход          | Контрол на реле за кръг 2             |
| **Кръг 3 Реле** (Подиум)              | 19  | Изход          | Контрол на реле за кръг 3             |
| **Бутон 0** (Централен 1)             | 12  | Вход (Pull-up) | Ръчно превключване за кръг 0          |
| **Бутон 1** (Централен 2)             | 13  | Вход (Pull-up) | Ръчно превключване за кръг 1          |
| **Бутон 2** (Баня)                    | 14  | Вход (Pull-up) | Ръчно превключване за кръг 2          |
| **Бутон 3** (Подиум)                  | 15  | Вход (Pull-up) | Ръчно превключване за кръг 3          |
| **Leveling Sensor SDA** (MPU6050)    | 21  | Вход/Изход     | I²C SDA за нивелиращ сензор (GY-521)  |
| **Leveling Sensor SCL** (MPU6050)    | 22  | Вход/Изход     | I²C SCL за нивелиращ сензор (GY-521)  |
| **BOOT Бутон** (Зануляване)          | 0   | Вход (Pull-up) | Дълго натискане (3с) за зануляване    |
| **Вградена LED** (Обратна връзка)    | 2   | Изход          | Визуална обратна връзка (3 бързи мигания) |

### Детайли за отоплителните кръгове

| Кръг  | Име         | Пин Темп. Сензор | Пин Реле | Пин Бутон |
| ----- | ----------- | ---------------- | -------- | --------- |
| **0** | Централен 1 | 25               | 4        | 12        |
| **1** | Централен 2 | 26               | 5        | 13        |
| **2** | Баня        | 27               | 18       | 14        |
| **3** | Подиум      | 33               | 19       | 15        |

### Спецификации на температурните сензори

**DS18B20 (Всички кръгове):**

- Диапазон температура: -55°C до 125°C
- Точност: ±0.5°C
- Резолюция: 12-бит (0.0625°C точност)
- Интервал на измерване: 5 секунди (всяко измерване се записва в буфер)
- Усредняване: На всеки 6-то измерване (приблизително 30 секунди) се изчислява средна стойност
- OneWire протокол с изискван pull-up резистор 4.7kΩ

### Настройки за температурен контрол

- **Целева температура**: 33°C (по подразбиране, конфигурируема в бъдеще)
- **Хистерезис**: 2°C
- **Изключване**: Когато температурата достигне 33°C
- **Включване**: Когато температурата падне под 32°C
- **Интервал на измерване**: 5 секунди (всяко измерване се записва в буфер)
- **Усредняване**: На всеки 6-то измерване (приблизително 30 секунди) се изчислява средна стойност
- **Публикуване на температура**: Само когато усреднената температура се различава от последно изпратената (за да се намали трафикът)
- **Интервал на контрол**: 30 секунди (проверка на автоматичен контрол) или веднага когато има нова усреднена температура

## Мрежова конфигурация

- **WiFi SSID**: `SmartCamper`
- **WiFi Парола**: `12344321`
- **MQTT Broker IP**: `192.168.4.1` (Raspberry Pi)
- **MQTT Broker Порт**: `1883`
- **ID на модула**: `module-3`

## Нивелиращ сензор (MPU6050 / GY-521)

### Хардуерна конфигурация

**Сензор:** GY-521 платка с MPU6050 (6-DOF IMU)
- **I²C SDA:** GPIO 21
- **I²C SCL:** GPIO 22
- **Захранване:** 3.3V (VCC), GND
- **Комуникация:** I²C протокол

**Функция за зануляване:**
- **Бутон:** BOOT бутон (GPIO 0)
- **Действие:** Дълго натискане за 3 секунди за запазване на текущата позиция като нулева референция
- **Обратна връзка:** Вградена LED (GPIO 2) мига 3 пъти + сериално съобщение
- **Съхранение:** Нулевите отмествания се запазват в ESP32 Preferences (неизтриваема flash памет)

### Спецификации на сензора

- **Тип:** MPU6050 (6-DOF: 3-осев акселерометър + 3-осев жироскоп)
- **Диапазон:** ±16g (акселерометър), ±2000°/s (жироскоп)
- **Точност:** ±0.5° за нивелиращи приложения
- **Калибриране:** Само жироскоп (акселерометърът използва гравитацията като абсолютна референция)
- **Честота на обновяване:** 0.5 секунди когато е активен (по заявка)

### Режим на работа

**Поток от данни по заявка:**
- Сензорът измерва и публикува само когато е активно заявен
- Frontend изпраща `start` команда на всеки 10 секунди (keep-alive)
- ESP32 публикува данни на всеки 0.5 секунди за 22 секунди след последната `start` команда
- Автоматично спира измерването и публикуването след timeout
- Спестява енергия и намалява MQTT трафик когато не се използва

### Процедура за зануляване

1. Паркирайте кемпера в желаната нивелирана позиция
2. Уверете се, че сензорът е здраво закрепен
3. Натиснете и задръжте BOOT бутона (GPIO 0) за 3 секунди
4. LED мига 3 пъти (визуално потвърждение)
5. Сериално съобщение потвърждава зануляването
6. Текущите pitch и roll ъгли се запазват като нулеви отмествания в flash паметта
7. При следващо стартиране, сензорът използва запазените отмествания като референция

### Измерване на ъгли

- **Pitch (X-ос):** Наклон напред/назад (положителен = наклон напред)
- **Roll (Y-ос):** Наклон наляво/надясно (положителен = наклон надясно)
- **Точност:** Закръглено до 0.2° за показване
- **Диапазон:** -15° до +15° (покрива екстремни случаи до 25% наклон)

### Допустими диапазони за дейности

**Sleep (Спане):**
- Pitch: от -2° до +2°
- Roll: от -1° до +2°

**Cook (Готвене):**
- И двете оси: от -1° до +1°

**Shower (Душ):**
- Pitch: от -1° до 0°
- Roll: от 0° до +1°

**Drain (Празнене/На водата):**
- Pitch: 0° или по-голям (>= 0°)
- Roll: 0° или по-малък (<= 0°)

## MQTT Topics

### Публикувани (Статус и данни от сензори)

| Topic                                        | Формат на съобщението                                                                                                                                         | Честота на обновяване                                                                                                                                                                   |
| -------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `smartcamper/sensors/module-3/status`        | `{"type": "full", "data": {"circles": {...}}}` или `{"type": "circle", "index": 0, "mode": "TEMP_CONTROL", "relay": "ON", "temperature": 32, "error": false}` | При промяна (натискане на бутон, MQTT команда, автоматична промяна, force_update) или когато усреднената температура се различава от последно изпратената (приблизително на 30 секунди) |
| `smartcamper/sensors/module-3/leveling`      | `{"pitch": 1.2, "roll": -0.8}`                                                                                                                                 | На всеки 0.5 секунди когато е активен (по заявка, timeout: 22 секунди)                                                                                                                  |
| `smartcamper/errors/module-3/circle/{index}` | `{"error": true, "type": "sensor_disconnected", "message": "Temperature sensor disconnected", "timestamp": 1234567890}`                                       | Веднъж при възникване на грешка                                                                                                                                                         |
| `smartcamper/heartbeat/module-3`             | `{"timestamp": 1234567890, "moduleId": "module-3", "uptime": 3600, "wifiRSSI": -65}`                                                                          | На всеки 10 секунди                                                                                                                                                                     |

### Абонирани (Команди)

| Topic                                              | Payload | Действие                                               |
| -------------------------------------------------- | ------- | ------------------------------------------------------ |
| `smartcamper/commands/module-3/circle/{index}/on`  | `{}`    | Включване на TEMP_CONTROL режим (температурен контрол) |
| `smartcamper/commands/module-3/circle/{index}/off` | `{}`    | Изключване на кръг (OFF режим)                         |
| `smartcamper/commands/module-3/leveling/start`     | `{}`    | Стартиране на нивелиращ сензор (активира за 22 секунди, нулира timeout) |
| `smartcamper/commands/module-3/force_update`       | `{}`    | Принудително обновяване на статус                      |

## Функционалности

### Режими на кръговете

**OFF Режим:**

- Кръгът е напълно изключен
- Няма измерване на температура
- Релето е изключено
- Бутонът превключва към TEMP_CONTROL режим

**TEMP_CONTROL Режим:**

- Кръгът е в автоматичен температурен контрол
- Температурата се измерва на всеки 5 секунди с async неблокиращ метод
- Всяко измерване се записва в буфер
- На всеки 6-то измерване (приблизително 30 секунди) се изчислява средна стойност от всички 6 измервания
- Конверсията на температурата отнема ~800ms (неблокиращо, не блокира обработката на бутоните)
- Автоматично управление на релето според усреднената температура:
  - Реле ON когато усреднената температура < 32°C
  - Реле OFF когато усреднената температура >= 33°C
- Релето се включва веднага след първото усредняване на температурата (~30 секунди след включване на кръга)
- Хистерезис предотвратява бързо превключване (разлика 2°C)
- Работи напълно офлайн (не се изисква мрежа)
- Проверка на контрол на всеки 30 секунди (или веднага когато има нова усреднена температура)
- Публикуване на температурата само когато се различава от последно изпратената (за оптимизация на трафика)
- Бутонът превключва към OFF режим

### Обработка на грешки

- Ако сензорът не успее 3 последователни четения (3 неуспешни опита, ~2.4 секунди общо), кръгът се изключва автоматично (OFF режим)
- Грешката се публикува в topic `smartcamper/errors/module-3/circle/{index}` (публикува се веднъж при възникване на грешка)
- Ако сензорът не е намерен при инициализация, грешката се докладва веднага
- Когато сензорът се възстанови, се публикува нормален статус и кръгът автоматично се връща към предишното състояние (TEMP_CONTROL ако е бил включен)

### Офлайн работа

- Всички функции работят без WiFi/MQTT връзка
- Автоматичният температурен контрол продължава офлайн
- Физическите бутони работят офлайн
- Обновленията на статус се публикуват само при свързаност

## Инсталация и настройка

1. **Качване на firmware:**

   ```bash
   cd esp32-modules/module-3
   pio run --target upload
   ```

2. **Мониторинг на serial изход:**

   ```bash
   pio device monitor
   ```

   - Проверка на WiFi/MQTT връзка
   - Мониторинг на температурни показания
   - Проверка на промени в състоянието на релетата
   - Мониторинг на натискания на бутони

3. **Проверка на работата:**
   - Проверете dashboard-а за статус на кръговете
   - Тест на физическите бутони (трябва да превключват кръговете)
   - Проверете автоматичния контрол (наблюдавайте температурата и състоянието на релето)
   - Проверете статус иконката за heartbeat (синьо = онлайн, червено = офлайн)

## Отстраняване на проблеми

### Няма WiFi връзка

- Проверете SSID и парола в `src/Config.h`
- Уверете се, че WiFi рутерът излъчва мрежата `SmartCamper`
- Проверете serial изхода за грешки при свързване

### Няма MQTT връзка

- Проверете IP адреса на MQTT broker в `src/Config.h` (по подразбиране: `192.168.4.1`)
- Проверете дали Raspberry Pi работи и MQTT broker е активен
- Проверете мрежовата свързаност (ping на MQTT broker IP)

### Температурен сензор не работи

- **DS18B20**: Проверете OneWire pull-up резистор (4.7kΩ) на всеки сензорен пин
- Проверете свързването на сензора (VCC, GND, DATA пин)
- Уверете се, че сензорът е правилно запечатан и позициониран
- Проверете serial изхода за грешки от сензорите (търсете "Failed to read temperature")
- Тест на сензора с мултиметър (трябва да показва ~3.3V на DATA пин когато е в покой)

### Реле не превключва

- Проверете свързването на релето (пинове на релета: 4, 5, 18, 19)
- Проверете захранването на реле модула (12V за намотката на релето)
- Тест на релето с мултиметър (трябва да показва проводимост когато е ON)
- Проверете serial изхода за промени в състоянието на релето
- Уверете се, че реле модулът е правилно свързан (IN пин към ESP32, VCC/GND към захранване)

### Бутон не работи

- Проверете свързването на бутона (пинове на бутони: 12, 13, 14, 15)
- Проверете pull-up резисторите (използват се вътрешни pull-up-и)
- Тест с мултиметър (бутонът трябва да свързва пин към GND при натискане)
- Проверете serial изхода за съобщения за натискане на бутон
- Уверете се, че бутонът е моментарен натискащ бутон (нормално отворен)
- Debouncing на бутона: 100ms забавяне за debounce, 300ms минимален интервал между натискания
- Ако бутонът не реагира, проверете за блокиращи операции в кода (не трябва да има такива)

### Автоматичен контрол не работи

- Проверете дали температурният сензор чете правилно (проверете serial изхода)
- Проверете дали кръгът е в режим на ръчно управление (бутон е бил натиснат)
- Проверете температурните прагове в `src/Config.h`:
  - `HEATING_TURN_OFF_TEMP`: 33°C
  - `HEATING_TURN_ON_TEMP`: 32°C
- Проверете serial изхода за съобщения за автоматичен контрол
- Уверете се, че интервалът на измерване е правилен (30 секунди)

### Кръг остава ON/OFF

- Проверете режима на кръга (OFF или TEMP_CONTROL) в serial изхода
- Проверете показанието на температурния сензор (трябва да е валидно, не 0 или NaN)
- Проверете състоянието на релето в serial изхода
- Проверете дали сензорът има грешка (3 неуспешни четения ще изключат кръга)
- Опитайте да включите TEMP_CONTROL режим чрез MQTT: `smartcamper/commands/module-3/circle/{index}/on`

### Грешно показание на температура

- Проверете дали DS18B20 сензорът е правилно запечатан и позициониран
- Проверете за разхлабени свързвания на DATA пин на сензора
- Проверете pull-up резистора (4.7kΩ) е свързан между DATA и VCC
- Проверете дали сензорът не е повреден (тест с друг сензор)
- Проверете адреса на сензора (ако има множество сензори на същия OneWire bus)

## Офлайн работа

Модулът работи напълно независимо:

- Автоматичният температурен контрол работи без WiFi/MQTT
- Физическите бутони функционират офлайн
- Температурните сензори продължават да четат офлайн
- Обновленията на статус се публикуват само при възстановяване на връзката
- Няма грешки когато е офлайн - всички локални функции работят нормално

## Електрически спецификации

- **Температурни сензори**: DS18B20, 3.3V-5V, OneWire протокол
- **Pull-up резистор**: 4.7kΩ (изисква се за всеки DS18B20 сензор)
- **Релета**: Стандартни 12V реле модули (NO/NC контакти)
- **Намотка на реле**: 12V DC (проверете спецификациите на реле модула)
- **Бутони**: Моментарни натискащи бутони (нормално отворени)
- **Захранване**: 5V за ESP32, 12V за намотките на релетата

## Архитектура

- **ModuleManager**: Управлява WiFi, MQTT, Heartbeat, Команди
- **FloorHeatingManager**: Координира цялата функционалност за подово отопление
- **FloorHeatingController**: Управлява контрола на релетата и автоматичния температурен контрол
- **FloorHeatingSensor**: Четене и усредняване на температурни сензори (DS18B20) - използва async неблокираща state machine
- **FloorHeatingButtonHandler**: Обработва входове от бутони (debouncing, toggle) - неблокираща операция
- **LevelingSensor**: Управление на MPU6050 сензор, измерване на ъгли, зануляване, поток от данни по заявка

### Оптимизации за производителност

- **Неблокиращо четене на температура**: Използва async state machine (конверсията започва, след това се чете след ~800ms)
- **Буфериране и усредняване**: Температурата се измерва на всеки 5 секунди и се записва в буфер. На всеки 6-то измерване (30 секунди) се изчислява средна стойност за по-стабилни показания
- **Оптимизирано публикуване**: Температурата се публикува само когато се различава от последно изпратената, намалявайки MQTT трафика
- **Веднагашен контрол на релето**: Релето се включва веднага след първото усредняване на температурата (~30 секунди след включване на кръга)
- **Няма блокиращи забавяния**: Всички операции са неблокиращи за осигуряване на отзивчива обработка на бутоните
- **Оптимизиран debouncing**: 100ms забавяне за debounce с 300ms минимален интервал между натискания

## Serial Debug Изход

Включване/изключване в `src/Config.h`:

- `DEBUG_SERIAL`: Serial конзолен изход
- `DEBUG_MQTT`: MQTT съобщения за публикуване/абониране
- `DEBUG_VERBOSE`: Подробни показания от сензорите и решения за контрол

## Бъдещи функционалности (Подготвени в кода)

- Конфигурируема целева температура (в момента фиксирана на 33°C)
- Регулиране на температура чрез MQTT команди
- Контрол базиран на график
- Мониторинг на консумация на енергия
