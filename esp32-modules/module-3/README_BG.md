# Module-3: Контролер за подово отопление

ESP32 модул за управление на система за подово отопление с автоматичен температурен контрол, бутони за ръчно управление и 4 независими отоплителни кръга.

## Хардуерна конфигурация

### Таблица с пинове

| Компонент                             | Пин | Тип            | Описание                              |
| ------------------------------------- | --- | -------------- | ------------------------------------- |
| **Кръг 0 Темп. Сензор** (Централен 1) | 25  | Вход           | DS18B20 температурен сензор (OneWire) |
| **Кръг 1 Темп. Сензор** (Централен 2) | 26  | Вход           | DS18B20 температурен сензор (OneWire) |
| **Кръг 2 Темп. Сензор** (Баня)        | 27  | Вход           | DS18B20 температурен сензор (OneWire) |
| **Кръг 3 Темп. Сензор** (Подиум)      | 33  | Вход           | DS18B20 температурен сензор (OneWire) |
| **Кръг 0 Реле** (Централен 1)         | 4   | Изход          | Контрол на реле за кръг 0             |
| **Кръг 1 Реле** (Централен 2)         | 5   | Изход          | Контрол на реле за кръг 1             |
| **Кръг 2 Реле** (Баня)                | 18  | Изход          | Контрол на реле за кръг 2             |
| **Кръг 3 Реле** (Подиум)              | 19  | Изход          | Контрол на реле за кръг 3             |
| **Бутон 0** (Централен 1)             | 12  | Вход (Pull-up) | Ръчно превключване за кръг 0          |
| **Бутон 1** (Централен 2)             | 13  | Вход (Pull-up) | Ръчно превключване за кръг 1          |
| **Бутон 2** (Баня)                    | 14  | Вход (Pull-up) | Ръчно превключване за кръг 2          |
| **Бутон 3** (Подиум)                  | 15  | Вход (Pull-up) | Ръчно превключване за кръг 3          |

### Детайли за отоплителните кръгове

| Кръг  | Име         | Пин Темп. Сензор | Пин Реле | Пин Бутон |
| ----- | ----------- | ---------------- | -------- | --------- |
| **0** | Централен 1 | 25               | 4        | 12        |
| **1** | Централен 2 | 26               | 5        | 13        |
| **2** | Баня        | 27               | 18       | 14        |
| **3** | Подиум      | 33               | 19       | 15        |

### Спецификации на температурните сензори

**DS18B20 (Всички кръгове):**

- Диапазон температура: -55°C до 125°C
- Точност: ±0.5°C
- Резолюция: 12-бит (0.0625°C точност)
- Интервал на обновяване: 1 секунда (средна стойност за 5 сек)
- OneWire протокол с изискван pull-up резистор 4.7kΩ

### Настройки за температурен контрол

- **Целева температура**: 33°C (по подразбиране, конфигурируема в бъдеще)
- **Хистерезис**: 2°C
- **Изключване**: Когато температурата достигне 33°C
- **Включване**: Когато температурата падне под 32°C
- **Интервал на измерване**: 30 секунди (проверка на автоматичен контрол)
- **Четене на температура**: На всеки 1 секунда (усреднена за 5 секунди)

## Мрежова конфигурация

- **WiFi SSID**: `SmartCamper`
- **WiFi Парола**: `12344321`
- **MQTT Broker IP**: `192.168.4.1` (Raspberry Pi)
- **MQTT Broker Порт**: `1883`
- **ID на модула**: `module-3`

## MQTT Topics

### Публикувани (Статус и данни от сензори)

| Topic                                             | Формат на съобщението                                                                                                                                         | Честота на обновяване                                                             |
| ------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| `smartcamper/sensors/module-3/status`             | `{"type": "full", "data": {"circles": {...}}}` или `{"type": "circle", "index": 0, "mode": "TEMP_CONTROL", "relay": "ON", "temperature": 32, "error": false}` | При промяна (натискане на бутон, MQTT команда, автоматична промяна, force_update) |
| `smartcamper/errors/module-3/circle/{index}`      | `{"error": true, "type": "sensor_disconnected", "message": "Temperature sensor disconnected", "timestamp": 1234567890}`                                       | Веднъж при възникване на грешка                                                   |
| `smartcamper/sensors/floor-heating-circle-0-temp` | `32.5`                                                                                                                                                        | При промяна (>0.1°C)                                                              |
| `smartcamper/sensors/floor-heating-circle-1-temp` | `31.8`                                                                                                                                                        | При промяна (>0.1°C)                                                              |
| `smartcamper/sensors/floor-heating-circle-2-temp` | `33.2`                                                                                                                                                        | При промяна (>0.1°C)                                                              |
| `smartcamper/sensors/floor-heating-circle-3-temp` | `30.5`                                                                                                                                                        | При промяна (>0.1°C)                                                              |
| `smartcamper/heartbeat/module-3`                  | `{"timestamp": 1234567890, "moduleId": "module-3", "uptime": 3600, "wifiRSSI": -65}`                                                                          | На всеки 10 секунди                                                               |

### Абонирани (Команди)

| Topic                                              | Payload | Действие                                               |
| -------------------------------------------------- | ------- | ------------------------------------------------------ |
| `smartcamper/commands/module-3/circle/{index}/on`  | `{}`    | Включване на TEMP_CONTROL режим (температурен контрол) |
| `smartcamper/commands/module-3/circle/{index}/off` | `{}`    | Изключване на кръг (OFF режим)                         |
| `smartcamper/commands/module-3/force_update`       | `{}`    | Принудително обновяване на статус                      |

## Функционалности

### Режими на кръговете

**OFF Режим:**

- Кръгът е напълно изключен
- Няма измерване на температура
- Релето е изключено
- Бутонът превключва към TEMP_CONTROL режим

**TEMP_CONTROL Режим:**

- Кръгът е в автоматичен температурен контрол
- Температурата се измерва непрекъснато (на всеки 1 секунда, усреднена за 5 секунди)
- Автоматично управление на релето според температурата:
  - Реле ON когато температурата < 32°C
  - Реле OFF когато температурата >= 33°C
- Хистерезис предотвратява бързо превключване (разлика 2°C)
- Работи напълно офлайн (не се изисква мрежа)
- Проверка на контрол на всеки 30 секунди
- Бутонът превключва към OFF режим

### Обработка на грешки

- Ако сензорът не успее 3 последователни четения (90 секунди), кръгът се изключва автоматично (OFF режим)
- Грешката се публикува в topic `smartcamper/errors/module-3/circle/{index}`
- Когато сензорът се възстанови, се публикува нормален статус и кръгът може да се включи отново

### Офлайн работа

- Всички функции работят без WiFi/MQTT връзка
- Автоматичният температурен контрол продължава офлайн
- Физическите бутони работят офлайн
- Обновленията на статус се публикуват само при свързаност

## Инсталация и настройка

1. **Качване на firmware:**

   ```bash
   cd esp32-modules/module-3
   pio run --target upload
   ```

2. **Мониторинг на serial изход:**

   ```bash
   pio device monitor
   ```

   - Проверка на WiFi/MQTT връзка
   - Мониторинг на температурни показания
   - Проверка на промени в състоянието на релетата
   - Мониторинг на натискания на бутони

3. **Проверка на работата:**
   - Проверете dashboard-а за статус на кръговете
   - Тест на физическите бутони (трябва да превключват кръговете)
   - Проверете автоматичния контрол (наблюдавайте температурата и състоянието на релето)
   - Проверете статус иконката за heartbeat (синьо = онлайн, червено = офлайн)

## Отстраняване на проблеми

### Няма WiFi връзка

- Проверете SSID и парола в `src/Config.h`
- Уверете се, че WiFi рутерът излъчва мрежата `SmartCamper`
- Проверете serial изхода за грешки при свързване

### Няма MQTT връзка

- Проверете IP адреса на MQTT broker в `src/Config.h` (по подразбиране: `192.168.4.1`)
- Проверете дали Raspberry Pi работи и MQTT broker е активен
- Проверете мрежовата свързаност (ping на MQTT broker IP)

### Температурен сензор не работи

- **DS18B20**: Проверете OneWire pull-up резистор (4.7kΩ) на всеки сензорен пин
- Проверете свързването на сензора (VCC, GND, DATA пин)
- Уверете се, че сензорът е правилно запечатан и позициониран
- Проверете serial изхода за грешки от сензорите (търсете "Failed to read temperature")
- Тест на сензора с мултиметър (трябва да показва ~3.3V на DATA пин когато е в покой)

### Реле не превключва

- Проверете свързването на релето (пинове на релета: 4, 5, 18, 19)
- Проверете захранването на реле модула (12V за намотката на релето)
- Тест на релето с мултиметър (трябва да показва проводимост когато е ON)
- Проверете serial изхода за промени в състоянието на релето
- Уверете се, че реле модулът е правилно свързан (IN пин към ESP32, VCC/GND към захранване)

### Бутон не работи

- Проверете свързването на бутона (пинове на бутони: 12, 13, 14, 15)
- Проверете pull-up резисторите (използват се вътрешни pull-up-и)
- Тест с мултиметър (бутонът трябва да свързва пин към GND при натискане)
- Проверете serial изхода за съобщения за натискане на бутон
- Уверете се, че бутонът е моментарен натискащ бутон (нормално отворен)

### Автоматичен контрол не работи

- Проверете дали температурният сензор чете правилно (проверете serial изхода)
- Проверете дали кръгът е в режим на ръчно управление (бутон е бил натиснат)
- Проверете температурните прагове в `src/Config.h`:
  - `HEATING_TURN_OFF_TEMP`: 33°C
  - `HEATING_TURN_ON_TEMP`: 32°C
- Проверете serial изхода за съобщения за автоматичен контрол
- Уверете се, че интервалът на измерване е правилен (30 секунди)

### Кръг остава ON/OFF

- Проверете режима на кръга (OFF или TEMP_CONTROL) в serial изхода
- Проверете показанието на температурния сензор (трябва да е валидно, не 0 или NaN)
- Проверете състоянието на релето в serial изхода
- Проверете дали сензорът има грешка (3 неуспешни четения ще изключат кръга)
- Опитайте да включите TEMP_CONTROL режим чрез MQTT: `smartcamper/commands/module-3/circle/{index}/on`

### Грешно показание на температура

- Проверете дали DS18B20 сензорът е правилно запечатан и позициониран
- Проверете за разхлабени свързвания на DATA пин на сензора
- Проверете pull-up резистора (4.7kΩ) е свързан между DATA и VCC
- Проверете дали сензорът не е повреден (тест с друг сензор)
- Проверете адреса на сензора (ако има множество сензори на същия OneWire bus)

## Офлайн работа

Модулът работи напълно независимо:

- Автоматичният температурен контрол работи без WiFi/MQTT
- Физическите бутони функционират офлайн
- Температурните сензори продължават да четат офлайн
- Обновленията на статус се публикуват само при възстановяване на връзката
- Няма грешки когато е офлайн - всички локални функции работят нормално

## Електрически спецификации

- **Температурни сензори**: DS18B20, 3.3V-5V, OneWire протокол
- **Pull-up резистор**: 4.7kΩ (изисква се за всеки DS18B20 сензор)
- **Релета**: Стандартни 12V реле модули (NO/NC контакти)
- **Намотка на реле**: 12V DC (проверете спецификациите на реле модула)
- **Бутони**: Моментарни натискащи бутони (нормално отворени)
- **Захранване**: 5V за ESP32, 12V за намотките на релетата

## Архитектура

- **ModuleManager**: Управлява WiFi, MQTT, Heartbeat, Команди
- **FloorHeatingManager**: Координира цялата функционалност за подово отопление
- **FloorHeatingController**: Управлява контрола на релетата и автоматичния температурен контрол
- **FloorHeatingSensor**: Четене и усредняване на температурни сензори (DS18B20)
- **FloorHeatingButtonHandler**: Обработва входове от бутони (debouncing, toggle)

## Serial Debug Изход

Включване/изключване в `src/Config.h`:

- `DEBUG_SERIAL`: Serial конзолен изход
- `DEBUG_MQTT`: MQTT съобщения за публикуване/абониране
- `DEBUG_VERBOSE`: Подробни показания от сензорите и решения за контрол

## Бъдещи функционалности (Подготвени в кода)

- Конфигурируема целева температура (в момента фиксирана на 33°C)
- Регулиране на температура чрез MQTT команди
- Контрол базиран на график
- Мониторинг на консумация на енергия
