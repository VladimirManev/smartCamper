# Module-2: LED Лент Контролер

ESP32 модул за управление на множество LED ленти с бутони, motion сензор, димиране и транзиции.

## Хардуерна конфигурация

### Таблица с пинове

| Компонент                        | Пин | Тип            | Описание                                  |
| -------------------------------- | --- | -------------- | ----------------------------------------- |
| **Strip 0** (Кухня основна)      | 33  | Изход          | 44 LED-а, RGBW                            |
| **Strip 1** (Основно осветление) | 18  | Изход          | 178 LED-а, RGBW                           |
| **Strip 2** (Кухня разширение)   | 19  | Изход          | 23 LED-а, RGBW (синхронизирана с Strip 0) |
| **Strip 3** (Баня)               | 25  | Изход          | 53 LED-а, RGBW (активирана от движение)   |
| **Strip 4** (Спалня)             | 5   | Изход          | 30 LED-а, RGBW (GRBW протокол)            |
| **Бутон 1**                      | 4   | Вход (Pull-up) | Контрол кухня (Strip 0+2)                 |
| **Бутон 2**                      | 12  | Вход (Pull-up) | Основно осветление (Strip 1)              |
| **Бутон 3**                      | 27  | Вход (Pull-up) | Превключване реле за под                  |
| **Бутон 4**                      | 13  | Вход (Pull-up) | Контрол спалня (Strip 4)                  |
| **Реле 0**                       | 26  | Изход          | Реле за подно осветление                  |
| **PIR Сензор**                   | 2   | Вход           | Откриване движение (Strip 3)              |

### Детайли за LED лентите

| Strip | LED-и | Тип         | Протокол | Контрол                                |
| ----- | ----- | ----------- | -------- | -------------------------------------- |
| **0** | 44    | WS2815 RGBW | RGBW     | Бутон 1                                |
| **1** | 178   | WS2815 RGBW | RGBW     | Бутон 2                                |
| **2** | 23    | WS2815 RGBW | RGBW     | Автоматично (синхронизирана с Strip 0) |
| **3** | 53    | WS2815 RGBW | RGBW     | PIR сензор + MQTT                      |
| **4** | 30    | WS2812 RGBW | GRBW     | Бутон 4                                |

### Функции на бутоните

- **Клик**: Превключване лента ON/OFF (с случайна транзиция)
- **Задържане** (>250ms): Старт димиране (яркост нагоре/надолу се редува)
- **Бутон 3**: Просто превключване реле (без димиране)

### Strip 3 (Баня) Режими

- **OFF**: Лента остава изключена
- **AUTO**: Motion сензор управлява лентата (таймаут 60 сек)
- **ON**: Лента остава включена

## Мрежова конфигурация

- **WiFi SSID**: `SmartCamper`
- **WiFi Парола**: `12344321`
- **MQTT Broker IP**: `192.168.4.1` (Raspberry Pi)
- **MQTT Broker Порт**: `1883`
- **ID на модула**: `module-2`
- **MQTT Buffer Size**: 1024 байта

## MQTT Topics

### Публикувани (Статус)

| Topic                                 | Формат на съобщението                                                        | Честота на обновяване                                             |
| ------------------------------------- | ---------------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `smartcamper/sensors/module-2/status` | `{"strips": {...}, "relays": {...}}`                                         | Само при промяна (натискане на бутон, MQTT команда, force_update) |
| `smartcamper/heartbeat/module-2`      | `{"timestamp": ..., "moduleId": "module-2", "uptime": ..., "wifiRSSI": ...}` | На всеки 10 секунди                                               |

### Абонирани (Команди)

| Topic                                                    | Payload                         | Действие                          |
| -------------------------------------------------------- | ------------------------------- | --------------------------------- |
| `smartcamper/commands/module-2/strip/{index}/on`         | `{}`                            | Включване на лента                |
| `smartcamper/commands/module-2/strip/{index}/off`        | `{}`                            | Изключване на лента               |
| `smartcamper/commands/module-2/strip/{index}/toggle`     | `{}`                            | Превключване лента                |
| `smartcamper/commands/module-2/strip/{index}/brightness` | `{"value": 0-255}`              | Задаване яркост                   |
| `smartcamper/commands/module-2/strip/3/mode`             | `{"mode": "OFF"\|"AUTO"\|"ON"}` | Задаване режим Strip 3            |
| `smartcamper/commands/module-2/relay/toggle`             | `{}`                            | Превключване реле                 |
| `smartcamper/commands/module-2/force_update`             | `{}`                            | Принудително обновяване на статус |

## Функционалности

### Транзиции

- 8 различни транзиционни ефекта (4 за включване, 4 за изключване)
- Случайно избрани при всяко превключване
- Продължителност: 1 секунда

### Димиране

- Задържане на бутон >250ms за старт
- Скорост: 50 единици яркост/секунда
- Редува се увеличаване/намаляване
- Мига при достигане на максимум

### Motion Сензор

- PIR сензор на пин 2
- Активен само когато Strip 3 е в AUTO режим
- Таймаут 60 секунди след последно движение
- Автоматично включване при откриване на движение

## Инсталация и настройка

1. **Качване на firmware:**

   ```bash
   cd esp32-modules/module-2
   pio run --target upload
   ```

2. **Мониторинг на serial изход:**

   ```bash
   pio device monitor
   ```

   - Проверка на WiFi/MQTT връзка
   - Мониторинг на натискания на бутони
   - Проверка на статус на LED ленти

3. **Проверка на работата:**
   - Тест на физическите бутони
   - Проверка на frontend dashboard
   - Проверка на motion сензор (Strip 3 в AUTO режим)

## Отстраняване на проблеми

### Няма отговор от LED-ите

- Проверете захранването (12V за WS2815 ленти)
- Проверете свързванията на data пиновете (33, 18, 19, 25, 5)
- Проверете serial изхода за грешки
- Уверете се в правилно ground свързване между ESP32 и LED лентите

### Бутоните не работят

- Проверете свързването на бутоните (пинове 4, 12, 27, 13)
- Проверете pull-up резисторите (използват се вътрешни pull-up-и)
- Тест с мултиметър (бутонът трябва да свързва пин към GND при натискане)
- Проверете serial изхода за съобщения за натискане

### Motion сензорът не работи

- Уверете се, че Strip 3 е в AUTO режим (проверете frontend или MQTT)
- Проверете свързването на PIR сензора (пин 2, VCC, GND)
- Регулирайте чувствителност на PIR (ако е наличен потенциометър)
- Проверете serial изхода за съобщения за откриване на движение

### Димирането не работи

- Уверете се, че лентата е включена преди задържане на бутон
- Задръжте бутон >250ms за активиране на димиране
- Strip 3 в AUTO режим не поддържа димиране (използвайте ON/OFF режим)
- Проверете serial изхода за съобщения за димиране

### Няма MQTT връзка

- Проверете IP адреса на MQTT broker в `src/Config.h`
- Проверете статуса на WiFi връзката
- Уверете се, че MQTT broker работи на Raspberry Pi
- Проверете serial изхода за MQTT грешки

## Офлайн работа

Модулът работи независимо:

- Физическите бутони функционират без WiFi/MQTT
- LED лентите могат да се управляват чрез бутони офлайн
- PIR сензорът работи офлайн (Strip 3 в AUTO режим)
- Обновленията на статус се публикуват само при свързаност
- Няма грешки когато е офлайн - всички локални функции работят

## Електрически спецификации

- **LED Ленти**: WS2815/WS2812 RGBW, 12V
- **Консумация на ток**: Варира по лента (изчислете според LED-ите и яркостта)
- **Захранване**: 12V DC (достатъчен капацитет за всички ленти)
- **Реле**: Стандартен 12V реле модул (NO/NC контакти)
- **Бутони**: Моментарни натискащи бутони (нормално отворени)

## Архитектура

- **ModuleManager**: WiFi, MQTT, Heartbeat, Команди
- **LEDManager**: Координира цялата LED функционалност
- **LEDStripController**: Управлява LED лентите (контрол, транзиции, димиране)
- **ButtonHandler**: Обработва входове от бутони (debouncing, state machine)
- **RelayController**: Контролира реле за подно осветление
- **PIRSensorHandler**: Откриване движение за Strip 3

## Serial Debug Изход

Включване/изключване в `src/Config.h`:

- `DEBUG_SERIAL`: Serial конзолен изход
- `DEBUG_MQTT`: MQTT съобщения за публикуване/абониране
- `DEBUG_VERBOSE`: Подробни промени в състоянието на LED лентите
