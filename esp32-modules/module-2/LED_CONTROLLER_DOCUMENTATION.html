<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LED Controller Module Documentation</title>
    <style>
      @media print {
        @page {
          size: A4;
          margin: 2cm;
        }
        body {
          margin: 0;
        }
      }
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background-color: #fff;
      }
      h1 {
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }
      h2 {
        color: #34495e;
        border-bottom: 2px solid #ecf0f1;
        padding-top: 20px;
        margin-top: 30px;
      }
      h3 {
        color: #7f8c8d;
        margin-top: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        page-break-inside: avoid;
      }
      th {
        background-color: #3498db;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: bold;
      }
      td {
        border: 1px solid #ddd;
        padding: 10px;
      }
      tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      tr:hover {
        background-color: #f5f5f5;
      }
      .section {
        margin-bottom: 30px;
      }
      ul,
      ol {
        margin: 10px 0;
        padding-left: 30px;
      }
      code {
        background-color: #f4f4f4;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: "Courier New", monospace;
      }
      .note {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        margin: 20px 0;
      }
      .info-box {
        background-color: #e7f3ff;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin: 20px 0;
      }
      pre {
        background-color: #f4f4f4;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>LED Controller Module Documentation</h1>

    <div class="section">
      <h2>Overview</h2>
      <p>
        The LED Controller module is an ESP32-based multi-strip LED controller
        that manages up to 5 independent LED strips (all WS2815/WS2812 RGBW
        strips). It supports button control, motion sensor activation, dimming,
        transitions, synchronized control for kitchen lighting, and
        MQTT/WebSocket integration for remote control.
      </p>
    </div>

    <div class="section">
      <h2>Hardware Specifications</h2>
      <ul>
        <li><strong>Microcontroller:</strong> ESP32</li>
        <li>
          <strong>LED Types:</strong>
          <ul>
            <li>WS2815 RGBW (12V) - Strips 0-3</li>
            <li>WS2812 RGBW (12V, GRBW protocol) - Strip 4 (Bedroom)</li>
          </ul>
        </li>
        <li><strong>Number of Strips:</strong> 5</li>
        <li>
          <strong>RMT Channels:</strong> Each strip uses a separate RMT channel
          (RMT0-RMT4)
        </li>
      </ul>
    </div>

    <div class="section">
      <h2>LED Strips Configuration</h2>
      <table>
        <thead>
          <tr>
            <th>Strip Index</th>
            <th>Pin</th>
            <th>LED Count</th>
            <th>RMT Channel</th>
            <th>LED Type</th>
            <th>Description</th>
            <th>Control</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Strip 0</strong></td>
            <td>33</td>
            <td>44</td>
            <td>RMT0</td>
            <td>RGBW</td>
            <td>Kitchen (main)</td>
            <td>Button 1 (Pin 4)</td>
          </tr>
          <tr>
            <td><strong>Strip 1</strong></td>
            <td>18</td>
            <td>178</td>
            <td>RMT1</td>
            <td>RGBW</td>
            <td>Main lighting</td>
            <td>Button 2 (Pin 12)</td>
          </tr>
          <tr>
            <td><strong>Strip 2</strong></td>
            <td>19</td>
            <td>23</td>
            <td>RMT2</td>
            <td>RGBW</td>
            <td>Kitchen extension (spice rack)</td>
            <td>Auto-synced with Strip 0</td>
          </tr>
          <tr>
            <td><strong>Strip 3</strong></td>
            <td>25</td>
            <td>53</td>
            <td>RMT3</td>
            <td>RGBW</td>
            <td>Bathroom</td>
            <td>Button 4 (Pin 13) + PIR sensor (Pin 2)</td>
          </tr>
          <tr>
            <td><strong>Strip 4</strong></td>
            <td>5</td>
            <td>30</td>
            <td>RMT4</td>
            <td>RGBW</td>
            <td>Bedroom (GRBW protocol)</td>
            <td>Button 4 (Pin 13)</td>
          </tr>
        </tbody>
      </table>

      <div class="info-box">
        <h3>Strip Synchronization</h3>
        <ul>
          <li>
            <strong>Strip 0 and Strip 2</strong> are synchronized in software
          </li>
          <li>When Strip 0 is turned on/off, Strip 2 automatically follows</li>
          <li>Both strips use the same brightness, transitions, and dimming</li>
          <li>They use different RMT channels but are controlled together</li>
        </ul>
      </div>

      <div class="note">
        <h3>Strip 3 (Bathroom) - Motion-Activated with Manual Control</h3>
        <p>Strip 3 has three operating modes:</p>
        <ul>
          <li><strong>OFF</strong>: Strip is off, motion sensor is ignored</li>
          <li>
            <strong>AUTO</strong>: Motion sensor controls the strip (default
            behavior)
            <ul>
              <li>Automatically turns on when motion is detected</li>
              <li>Resets timeout timer on each motion detection</li>
              <li>Automatically turns off after 60 seconds of no motion</li>
              <li>Remembers last brightness setting (default: 50%)</li>
            </ul>
          </li>
          <li><strong>ON</strong>: Strip stays on, motion sensor is ignored</li>
        </ul>
        <p>The mode can be changed via:</p>
        <ul>
          <li>Frontend UI (3-position button: OFF/AUTO/ON)</li>
          <li>
            MQTT command:
            <code>smartcamper/commands/led-controller/strip/3/mode</code> with
            payload <code>{"mode": "OFF"|"AUTO"|"ON"}</code>
          </li>
        </ul>
      </div>
    </div>

    <div class="section">
      <h2>Buttons Configuration</h2>
      <table>
        <thead>
          <tr>
            <th>Button</th>
            <th>Pin</th>
            <th>Controls</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Button 1</strong></td>
            <td>4</td>
            <td>Strip 0 + Strip 2</td>
            <td>Kitchen - toggles main and extension strips together</td>
          </tr>
          <tr>
            <td><strong>Button 2</strong></td>
            <td>12</td>
            <td>Strip 1</td>
            <td>Main lighting control</td>
          </tr>
          <tr>
            <td><strong>Button 3</strong></td>
            <td>27</td>
            <td>Floor lighting</td>
            <td>Floor lighting relay control (toggle only)</td>
          </tr>
          <tr>
            <td><strong>Button 4</strong></td>
            <td>13</td>
            <td>Strip 4</td>
            <td>Bedroom lighting control</td>
          </tr>
        </tbody>
      </table>

      <h3>Button Functions</h3>
      <ul>
        <li>
          <strong>Click:</strong> Toggle strip ON/OFF (with random transitions)
        </li>
        <li>
          <strong>Hold</strong> (&gt;250ms): Start dimming (increase/decrease
          brightness) - <em>Not available for Button 3</em>
        </li>
        <li>
          <strong>Button 3:</strong> Simple toggle for floor lighting relay (no
          dimming)
        </li>
        <li>
          <strong>Button 4:</strong> Full control for Strip 4 (Bedroom) - same
          as Button 2
        </li>
      </ul>
    </div>

    <div class="section">
      <h2>Additional Circuits</h2>

      <h3>Floor Lighting (Relay Circuit)</h3>
      <table>
        <thead>
          <tr>
            <th>Component</th>
            <th>Pin</th>
            <th>Direction</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Relay</strong></td>
            <td>26</td>
            <td>Output</td>
            <td>Floor lighting relay control</td>
          </tr>
          <tr>
            <td><strong>Button 3</strong></td>
            <td>27</td>
            <td>Input</td>
            <td>Floor lighting toggle button</td>
          </tr>
        </tbody>
      </table>

      <div class="info-box">
        <h3>Floor Lighting Features</h3>
        <ul>
          <li>Controlled via relay (GPIO 26)</li>
          <li>Toggle button on GPIO 27</li>
          <li>Simple ON/OFF control (no dimming)</li>
          <li>Uses standard LED diodes (not LED strips)</li>
          <li>Independent from LED strip controls</li>
        </ul>
      </div>
    </div>

    <div class="section">
      <h2>Sensors Configuration</h2>
      <table>
        <thead>
          <tr>
            <th>Sensor</th>
            <th>Pin</th>
            <th>Controls</th>
            <th>Settings</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>PIR Motion Sensor (HC-SR501)</strong></td>
            <td>2</td>
            <td>Strip 3 (Bathroom)</td>
            <td>Timeout: 60 seconds (1 minute)</td>
          </tr>
        </tbody>
      </table>

      <h3>Motion Sensor Behavior</h3>
      <ul>
        <li>Only active when Strip 3 is in <strong>AUTO</strong> mode</li>
        <li>Automatically turns on Strip 3 when motion is detected</li>
        <li>Resets timeout timer on each motion detection</li>
        <li>Automatically turns off after 60 seconds of no motion</li>
        <li>Motion sensor is completely ignored in OFF and ON modes</li>
      </ul>
    </div>

    <div class="section">
      <h2>Color Configuration</h2>
      <ul>
        <li>
          <strong>All Strips (RGBW):</strong> White using RGB+W channels
          <ul>
            <li>
              All channels (R, G, B, W) are set to the same brightness value
            </li>
            <li>Provides full-spectrum white light</li>
          </ul>
        </li>
        <li>
          <strong>Strip 4 (Bedroom):</strong> Uses warm white color
          <ul>
            <li>Special warm white configuration for cozy bedroom lighting</li>
            <li>Warm white proportions: R=100%, G=90%, B=75%</li>
            <li>
              Creates warmer, more comfortable light for bedroom environment
            </li>
          </ul>
        </li>
      </ul>
    </div>

    <div class="section">
      <h2>Brightness Settings</h2>
      <ul>
        <li><strong>Minimum Brightness:</strong> 1</li>
        <li><strong>Maximum Brightness:</strong> 255</li>
        <li>
          <strong>Default Brightness:</strong> 128 (50% on first power on)
        </li>
        <li><strong>Dimming Speed:</strong> 50 brightness units per second</li>
      </ul>
    </div>

    <div class="section">
      <h2>Features</h2>

      <h3>Transitions</h3>
      <p>The controller supports 8 different transition effects:</p>

      <p><strong>Turn On Transitions:</strong></p>
      <ol>
        <li>Center to Edges - Smoothly expands from center</li>
        <li>Random LEDs - Random LEDs turn on sequentially</li>
        <li>Left to Right - Sequential activation from left</li>
        <li>Edges to Center - Expands from edges to center</li>
      </ol>

      <p><strong>Turn Off Transitions:</strong></p>
      <ol>
        <li>Edges to Center - Turns off from edges</li>
        <li>Random LEDs - Random LEDs turn off sequentially</li>
        <li>Left to Right - Sequential deactivation from left</li>
        <li>Center to Edges - Turns off from center outward</li>
      </ol>

      <ul>
        <li>Transition duration: 1 second</li>
        <li>Randomly selected for each on/off action</li>
      </ul>

      <h3>Dimming</h3>
      <ul>
        <li>Activated by holding button for &gt;250ms</li>
        <li>Smooth brightness increase/decrease</li>
        <li>Alternates between increasing and decreasing</li>
        <li>Blinks when reaching maximum brightness</li>
        <li>
          Available for all strips except Strip 3 in AUTO mode (dimming works in
          OFF/ON modes)
        </li>
      </ul>

      <h3>Blinking</h3>
      <ul>
        <li>Occurs when brightness reaches maximum</li>
        <li>Duration: 300ms</li>
        <li>Minimum brightness during blink: 30% of current brightness</li>
        <li>Visual feedback for maximum brightness</li>
      </ul>
    </div>

    <div class="section">
      <h2>Communication Protocol</h2>

      <h3>MQTT Topics</h3>
      <p><strong>Status Publishing:</strong></p>
      <ul>
        <li>
          <code>smartcamper/sensors/led-controller/status</code> - Unified JSON
          with all strips and relays status
        </li>
      </ul>

      <p><strong>Command Topics:</strong></p>
      <ul>
        <li>
          <code>smartcamper/commands/led-controller/strip/{index}/on</code> -
          Turn on strip
        </li>
        <li>
          <code>smartcamper/commands/led-controller/strip/{index}/off</code> -
          Turn off strip
        </li>
        <li>
          <code>smartcamper/commands/led-controller/strip/{index}/toggle</code>
          - Toggle strip
        </li>
        <li>
          <code
            >smartcamper/commands/led-controller/strip/{index}/brightness</code
          >
          - Set brightness (payload: <code>{"value": 0-255}</code>)
        </li>
        <li>
          <code>smartcamper/commands/led-controller/strip/3/mode</code> - Set
          Strip 3 mode (payload: <code>{"mode": "OFF"|"AUTO"|"ON"}</code>)
        </li>
        <li>
          <code>smartcamper/commands/led-controller/relay/toggle</code> - Toggle
          relay
        </li>
      </ul>

      <h3>MQTT Message Format</h3>
      <p><strong>Status Message (JSON):</strong></p>
      <pre>
{
  "strips": {
    "0": {"state": "ON", "brightness": 128},
    "1": {"state": "OFF", "brightness": 128},
    "2": {"state": "ON", "brightness": 128},
    "3": {"state": "ON", "brightness": 128, "mode": "AUTO"},
    "4": {"state": "OFF", "brightness": 128}
  },
  "relays": {
    "0": {"state": "ON"}
  }
}</pre
      >

      <div class="info-box">
        <h3>Technical Details</h3>
        <ul>
          <li>MQTT buffer size: 1024 bytes</li>
          <li>JSON document size: 1024 bytes</li>
          <li>Status published every 10 seconds (heartbeat interval)</li>
          <li>Status also published on any state change</li>
        </ul>
      </div>
    </div>

    <div class="section">
      <h2>Pin Summary</h2>
      <table>
        <thead>
          <tr>
            <th>Component</th>
            <th>Pin</th>
            <th>Direction</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Strip 0</strong></td>
            <td>33</td>
            <td>Output</td>
            <td>Kitchen main LED strip</td>
          </tr>
          <tr>
            <td><strong>Strip 1</strong></td>
            <td>18</td>
            <td>Output</td>
            <td>Main lighting LED strip</td>
          </tr>
          <tr>
            <td><strong>Strip 2</strong></td>
            <td>19</td>
            <td>Output</td>
            <td>Kitchen extension LED strip</td>
          </tr>
          <tr>
            <td><strong>Strip 3</strong></td>
            <td>25</td>
            <td>Output</td>
            <td>Bathroom LED strip</td>
          </tr>
          <tr>
            <td><strong>Strip 4</strong></td>
            <td>5</td>
            <td>Output</td>
            <td>Bedroom LED strip</td>
          </tr>
          <tr>
            <td><strong>Button 1</strong></td>
            <td>4</td>
            <td>Input (Pull-up)</td>
            <td>Kitchen control button</td>
          </tr>
          <tr>
            <td><strong>Button 2</strong></td>
            <td>12</td>
            <td>Input (Pull-up)</td>
            <td>Main lighting button</td>
          </tr>
          <tr>
            <td><strong>Button 3</strong></td>
            <td>27</td>
            <td>Input (Pull-up)</td>
            <td>Floor lighting button</td>
          </tr>
          <tr>
            <td><strong>Button 4</strong></td>
            <td>13</td>
            <td>Input (Pull-up)</td>
            <td>Bedroom control button</td>
          </tr>
          <tr>
            <td><strong>Relay</strong></td>
            <td>26</td>
            <td>Output</td>
            <td>Floor lighting relay</td>
          </tr>
          <tr>
            <td><strong>PIR Sensor</strong></td>
            <td>2</td>
            <td>Input</td>
            <td>Motion detection sensor</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="section">
      <h2>Technical Details</h2>

      <h3>RMT Channels</h3>
      <p>
        Each LED strip requires a dedicated RMT (Remote Control) channel on
        ESP32:
      </p>
      <ul>
        <li>Strip 0: RMT0 (WS2815 RGBW)</li>
        <li>Strip 1: RMT1 (WS2815 RGBW)</li>
        <li>Strip 2: RMT2 (WS2815 RGBW)</li>
        <li>Strip 3: RMT3 (WS2815 RGBW)</li>
        <li>Strip 4: RMT4 (WS2812 RGBW, GRBW protocol)</li>
      </ul>
      <p>This allows independent timing control for each strip.</p>

      <h3>Debouncing</h3>
      <ul>
        <li>Button debounce delay: 50ms</li>
        <li>Separate debounce state machine for each button</li>
      </ul>

      <h3>State Management</h3>
      <p>Each strip maintains:</p>
      <ul>
        <li>On/Off state</li>
        <li>Current brightness level</li>
        <li>Dimming state and direction</li>
        <li>Transition state</li>
        <li>Blink state</li>
        <li>Mode (for Strip 3: OFF/AUTO/ON)</li>
        <li>Last auto brightness (for Strip 3 in AUTO mode)</li>
      </ul>

      <h3>Network Features</h3>
      <ul>
        <li>
          <strong>Non-blocking WiFi:</strong> WiFi connection attempts do not
          block main loop
        </li>
        <li>
          <strong>Local controls work offline:</strong> Buttons, PIR sensor, and
          LED control work even without WiFi/MQTT
        </li>
        <li>
          <strong>Auto-reconnect:</strong> Automatic reconnection to WiFi and
          MQTT when connection is lost
        </li>
        <li><strong>MQTT QoS:</strong> Level 0 (at most once delivery)</li>
      </ul>
    </div>

    <div class="section">
      <h2>Usage Examples</h2>

      <h3>Turning On Kitchen Lights</h3>
      <ol>
        <li>Press Button 1 (Pin 4)</li>
        <li>Strip 0 turns on with random transition</li>
        <li>Strip 2 automatically turns on simultaneously</li>
        <li>Both strips maintain synchronized brightness</li>
      </ol>

      <h3>Dimming Main Lighting</h3>
      <ol>
        <li>Press and hold Button 2 (Pin 12)</li>
        <li>Brightness starts changing (increase/decrease alternates)</li>
        <li>Release button to stop dimming</li>
        <li>Brightness stays at current level</li>
      </ol>

      <h3>Bathroom Control (Strip 3)</h3>
      <p><strong>AUTO Mode (Default):</strong></p>
      <ol>
        <li>Set mode to AUTO via frontend or MQTT</li>
        <li>Motion detected by PIR sensor (Pin 2)</li>
        <li>Strip 3 automatically turns on</li>
        <li>Timer resets on each motion detection</li>
        <li>Automatically turns off after 60 seconds of no motion</li>
      </ol>
      <p><strong>Manual Control:</strong></p>
      <ol>
        <li>Set mode to ON via frontend or MQTT - strip stays on</li>
        <li>Set mode to OFF via frontend or MQTT - strip stays off</li>
        <li>In ON/OFF modes, motion sensor is completely ignored</li>
        <li>Dimming works in ON/OFF modes (hold Button 4)</li>
      </ol>

      <h3>Bedroom Control (Strip 4)</h3>
      <ol>
        <li>Press Button 4 (Pin 13) to toggle on/off</li>
        <li>Hold Button 4 for dimming</li>
        <li>Full feature parity with Strip 1 (transitions, dimming, blink)</li>
      </ol>

      <h3>Floor Lighting Control</h3>
      <ol>
        <li>Press Button 3 (Pin 27)</li>
        <li>Relay (Pin 26) toggles ON/OFF</li>
        <li>Controls floor lighting circuit with standard LED diodes</li>
        <li>Simple toggle - no dimming or transitions</li>
      </ol>
    </div>

    <div class="section">
      <h2>Notes</h2>
      <ul>
        <li>Strip 2 (Kitchen extension) cannot be controlled independently</li>
        <li>
          Strip 3 (Bathroom) has three modes: OFF, AUTO, ON
          <ul>
            <li>In AUTO mode: motion sensor controls the strip</li>
            <li>
              In OFF/ON modes: motion sensor is ignored, manual control only
            </li>
          </ul>
        </li>
        <li>Strip 4 (Bedroom) uses RGBW type with GRBW protocol</li>
        <li>All strips use white color with RGB+W channels</li>
        <li>
          Strip 4 uses special warm white configuration for comfortable bedroom
          lighting
        </li>
        <li>Transitions are randomly selected for visual variety</li>
        <li>System initializes all strips to OFF state</li>
        <li>Floor lighting (relay circuit) is independent from LED strips</li>
        <li>Floor lighting uses standard LED diodes, not LED strips</li>
        <li>Floor lighting has simple toggle control (no dimming)</li>
        <li>
          System works offline - local controls (buttons, PIR) function without
          WiFi/MQTT
        </li>
        <li>
          MQTT buffer size increased to 1024 bytes to support unified status
          messages
        </li>
      </ul>
    </div>

    <div class="section">
      <h2>Version Information</h2>
      <ul>
        <li><strong>Module:</strong> LED Controller</li>
        <li><strong>Last Updated:</strong> 2024</li>
        <li><strong>Hardware:</strong> ESP32</li>
        <li>
          <strong>LED Types:</strong> WS2815 RGBW (Strips 0-3), WS2812 RGBW GRBW
          (Strip 4)
        </li>
        <li><strong>Number of Strips:</strong> 5</li>
        <li><strong>Number of Buttons:</strong> 4</li>
        <li><strong>Number of Relays:</strong> 1</li>
      </ul>
    </div>
  </body>
</html>
